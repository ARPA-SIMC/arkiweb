<!DOCTYPE html>  <html> <head>   <title>arkiweb.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               arkiweb.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Author: Emanuele Di Giacomo <a href="&#109;&#x61;&#x69;&#108;&#x74;&#111;:&#x65;&#x64;&#x69;g&#x69;&#97;&#x63;&#111;&#109;&#111;&#64;&#x61;&#x72;&#x70;&#x61;&#x2E;&#101;&#109;&#114;&#46;&#105;t">&#x65;&#x64;&#x69;g&#x69;&#97;&#x63;&#111;&#109;&#111;&#64;&#x61;&#x72;&#x70;&#x61;&#x2E;&#101;&#109;&#114;&#46;&#105;t</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
<span class="kd">var</span> <span class="nx">arkiweb</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">models</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">collections</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">postprocessors</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">},</span>
  <span class="nx">routers</span><span class="o">:</span> <span class="p">{},</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">ArkiwebParser</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">area</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;area:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">GRIB</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vals</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">k</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB:&quot;</span> <span class="o">+</span> <span class="nx">vals</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">ODIMH5</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vals</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">k</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="s2">&quot;ODIMH5:&quot;</span> <span class="o">+</span> <span class="nx">vals</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">level</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;level:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">GRIB1</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="p">[</span><span class="nx">i</span><span class="p">.</span><span class="nx">lt</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">l1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">l</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">l1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">l2</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">l</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">l2</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB1,&quot;</span> <span class="o">+</span> <span class="nx">l</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">GRIB2S</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB2S,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">lt</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sc</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">GRIB2D</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB2D,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">l1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">s1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">v1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">l2</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">s2</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">v2</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">ODIMH5</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;ODIMH5,range &quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">mi</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ma</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">origin</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;origin:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">GRIB1</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB1,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ce</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sc</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">pr</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">GRIB2</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB2,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ce</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sc</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">pt</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">bi</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">pi</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">BUFR</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;BUFR,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ce</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sc</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">ODIMH5</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;ODIMH5,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">wmo</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">rad</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">plc</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">proddef</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;proddef:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">GRIB</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vals</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">k</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB:&quot;</span> <span class="o">+</span> <span class="nx">vals</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">product</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;product:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">GRIB1</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB1,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">or</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ta</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">pr</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">GRIB2</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB2,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ce</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">di</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ca</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">no</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">BUFR</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="s2">&quot;BUFR,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ty</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">st</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ls</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">vals</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">k</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="nx">i</span><span class="p">.</span><span class="nx">va</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="nx">s</span> <span class="o">+=</span> <span class="nx">vals</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">ODIMH5</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="s2">&quot;ODIMH5,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ob</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">pr</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">quantity</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;quantity:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">ODIMH5</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">va</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">run</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;run:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">MINUTE</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">va</span> <span class="o">/</span> <span class="mi">60</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">va</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">h</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">h</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">m</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="s2">&quot;MINUTE,&quot;</span> <span class="o">+</span> <span class="nx">h</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">m</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">task</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;task:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">ODIMH5</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">i</span><span class="p">.</span><span class="nx">va</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">timerange</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;timerange:&quot;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">styles</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">GRIB1</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">un</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="o">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="o">:</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="o">:</span> <span class="s1">&#39;mo&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="o">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="o">:</span> <span class="s1">&#39;de&#39;</span><span class="p">,</span>
            <span class="mi">6</span><span class="o">:</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="o">:</span> <span class="s1">&#39;ce&#39;</span><span class="p">,</span>
            <span class="mi">10</span><span class="o">:</span> <span class="s1">&#39;h3&#39;</span><span class="p">,</span>
            <span class="mi">11</span><span class="o">:</span> <span class="s1">&#39;h6&#39;</span><span class="p">,</span>
            <span class="mi">12</span><span class="o">:</span> <span class="s1">&#39;h12&#39;</span><span class="p">,</span>
            <span class="mi">254</span><span class="o">:</span> <span class="s1">&#39;s&#39;</span>
          <span class="p">};</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB1,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ty</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">p1</span> <span class="o">+</span> <span class="nx">un</span><span class="p">[</span><span class="nx">i</span><span class="p">.</span><span class="nx">un</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">p2</span> <span class="o">+</span> <span class="nx">un</span><span class="p">[</span><span class="nx">i</span><span class="p">.</span><span class="nx">un</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">GRIB2</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">un</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="o">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="o">:</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="o">:</span> <span class="s1">&#39;mo&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="o">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="o">:</span> <span class="s1">&#39;de&#39;</span><span class="p">,</span>
            <span class="mi">6</span><span class="o">:</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="o">:</span> <span class="s1">&#39;ce&#39;</span><span class="p">,</span>
            <span class="mi">10</span><span class="o">:</span> <span class="s1">&#39;h3&#39;</span><span class="p">,</span>
            <span class="mi">11</span><span class="o">:</span> <span class="s1">&#39;h6&#39;</span><span class="p">,</span>
            <span class="mi">12</span><span class="o">:</span> <span class="s1">&#39;h12&#39;</span><span class="p">,</span>
            <span class="mi">254</span><span class="o">:</span> <span class="s1">&#39;s&#39;</span>
          <span class="p">};</span>
          <span class="k">return</span> <span class="s2">&quot;GRIB2,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ty</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">p1</span> <span class="o">+</span> <span class="nx">un</span><span class="p">[</span><span class="nx">i</span><span class="p">.</span><span class="nx">un</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">p2</span> <span class="o">+</span> <span class="nx">un</span><span class="p">[</span><span class="nx">i</span><span class="p">.</span><span class="nx">un</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">Timedef</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">un</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="o">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="o">:</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="o">:</span> <span class="s1">&#39;mo&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="o">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="o">:</span> <span class="s1">&#39;de&#39;</span><span class="p">,</span>
            <span class="mi">6</span><span class="o">:</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="o">:</span> <span class="s1">&#39;ce&#39;</span><span class="p">,</span>
            <span class="mi">10</span><span class="o">:</span> <span class="s1">&#39;h3&#39;</span><span class="p">,</span>
            <span class="mi">11</span><span class="o">:</span> <span class="s1">&#39;h6&#39;</span><span class="p">,</span>
            <span class="mi">12</span><span class="o">:</span> <span class="s1">&#39;h12&#39;</span><span class="p">,</span>
            <span class="mi">13</span><span class="o">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
          <span class="p">};</span>
          <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="s2">&quot;Timedef&quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">su</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">s</span> <span class="o">+=</span> <span class="s2">&quot;,-&quot;</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">s</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sl</span> <span class="o">+</span> <span class="nx">un</span><span class="p">[</span><span class="nx">i</span><span class="p">.</span><span class="nx">su</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">s</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">pt</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>If i.pt is not defined, then
the stat type is 255 and 
i.pl, i.pu are not defined
too (see 
arki/types/timerange.cc:1358).
If the stat type is 255, then
proctype = "-" (see
arki/types/timerange.cc:1403).</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">s</span> <span class="o">+=</span> <span class="s2">&quot;,-&quot;</span>
          <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>If i.pu is not defined, then
the stat unit is UNIT_MISSING = 255
and i.pl is not defined too
(see arki/types/timerange.cc:1361).
If stat unit is 255, then 
proclen = "-" (see
arki/types/timerange.cc:1408).</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">pu</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">s</span> <span class="o">+=</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">pl</span> <span class="o">+</span> <span class="nx">un</span><span class="p">[</span><span class="nx">i</span><span class="p">.</span><span class="nx">pu</span><span class="p">]</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">s</span> <span class="o">+=</span> <span class="s2">&quot;,-&quot;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nx">BUFR</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">decode</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">un</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="o">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="o">:</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="o">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="o">:</span> <span class="s1">&#39;mo&#39;</span><span class="p">,</span>
            <span class="mi">4</span><span class="o">:</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="o">:</span> <span class="s1">&#39;de&#39;</span><span class="p">,</span>
            <span class="mi">6</span><span class="o">:</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span>
            <span class="mi">7</span><span class="o">:</span> <span class="s1">&#39;ce&#39;</span><span class="p">,</span>
            <span class="mi">10</span><span class="o">:</span> <span class="s1">&#39;h3&#39;</span><span class="p">,</span>
            <span class="mi">11</span><span class="o">:</span> <span class="s1">&#39;h6&#39;</span><span class="p">,</span>
            <span class="mi">12</span><span class="o">:</span> <span class="s1">&#39;h12&#39;</span><span class="p">,</span>
            <span class="mi">13</span><span class="o">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
          <span class="p">};</span>
          <span class="k">return</span> <span class="s2">&quot;BUFR,&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">va</span> <span class="o">+</span> <span class="nx">un</span><span class="p">[</span><span class="nx">i</span><span class="p">.</span><span class="nx">un</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Dataset</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">description</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">description</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postprocess</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">postprocess</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bounding</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">bounding</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">features</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Format</span><span class="p">.</span><span class="nx">WKT</span><span class="p">().</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bounding</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">features</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">FieldValue</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">ArkiwebParser</span><span class="p">[</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">type</span><span class="p">].</span><span class="nx">styles</span><span class="p">[</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">s</span><span class="p">].</span><span class="nx">decode</span><span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Field</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">FieldValues</span><span class="p">();</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">values</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">),</span>
        <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">Datasets</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">model</span><span class="o">:</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Dataset</span><span class="p">,</span>
  <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;datasets&quot;</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">FieldValues</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">model</span><span class="o">:</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">,</span>
  <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;&quot;</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">Fields</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">model</span><span class="o">:</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Field</span><span class="p">,</span>
  <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span>
  <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">b</span> <span class="o">||</span> <span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stats</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">begin</span><span class="o">:</span> <span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;new Date(&quot;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">),</span>
        <span class="nx">end</span><span class="o">:</span> <span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;new Date(&quot;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">),</span>
        <span class="nx">count</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span>
        <span class="nx">size</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">s</span>
      <span class="p">};</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">fields</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">DatasetsSelection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click .arkiweb-datasets-selection-menu .arkiweb-datasets-selection-clear-selection&#39;</span><span class="o">:</span> <span class="s1">&#39;clearSelection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click .arkiweb-datasets-selection-menu .arkiweb-datasets-selection-submit-selection&#39;</span><span class="o">:</span> <span class="s1">&#39;submitSelection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click .arkiweb-datasets-selection-menu .arkiweb-datasets-seclection-toggle-allowed&#39;</span><span class="o">:</span> <span class="s1">&#39;toggleAllowed&#39;</span>
  <span class="p">},</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-datasets-selection-list&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-datasets-selection-menu .arkiweb-datasets-selection-submit-selection&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-datasets-selection-menu .arkiweb-datasets-selection-clear-selection&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">toggle</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-datasets-selection-menu .arkiweb-datasets-seclection-toggle-allowed&quot;</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">submit</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">clear</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">renderError</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">views</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">buttons</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">submit</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">clear</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">toggle</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">},</span>
  <span class="nx">empty</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">DatasetsSelectionItem</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
        <span class="nx">el</span><span class="o">:</span> <span class="nx">el</span>
      <span class="p">});</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">notifyChange</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">renderError</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nb">Error</span><span class="p">({</span> 
      <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">),</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Error while loading datasets: &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">statusText</span>
    <span class="p">});</span>
  <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">notifyChange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">submit</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">clear</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="nx">view</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">submitSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">clearSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">setSelection</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">toggleAllowed</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;*[allowed=false]&#39;</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">getSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">();</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">DatasetsSelectionItem</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click .arkiweb-dataset-name&#39;</span><span class="o">:</span> <span class="s1">&#39;showDataset&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click input:checkbox&#39;</span><span class="o">:</span> <span class="s1">&#39;notifyChange&#39;</span>
  <span class="p">},</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s2">&quot;#arkiweb-datasets-selection-item-tmpl&quot;</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input:checkbox&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">notifyChange</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">isSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;:checked&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">setSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">())</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">()))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">showDataset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#arkiweb-dataset-description-tmpl&quot;</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
    <span class="nx">div</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
    <span class="nx">div</span><span class="p">.</span><span class="nx">dialog</span><span class="p">({</span>
      <span class="nx">title</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="nx">autoOpen</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">modal</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Map</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Map</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">LayerSwitcher</span><span class="p">());</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">MousePosition</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">layer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">WMS</span><span class="p">(</span><span class="s2">&quot;OpenLayers WMS&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;http://vmap0.tiles.osgeo.org/wms/vmap0&quot;</span><span class="p">,</span> <span class="p">{</span>
                   <span class="nx">layers</span><span class="o">:</span> <span class="s1">&#39;basic&#39;</span>
                 <span class="p">});</span>
                 <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">layer</span><span class="p">);</span>
                 <span class="k">this</span><span class="p">.</span><span class="nx">blayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="s2">&quot;datasets bounding box&quot;</span><span class="p">);</span>
                 <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">blayer</span><span class="p">);</span>
                 <span class="k">this</span><span class="p">.</span><span class="nx">view</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">view</span><span class="p">;</span>
                 <span class="k">this</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateDatasetsFeatures</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">zoomToMaxExtent</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">updateDatasetsFeatures</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>    
    <span class="kd">var</span> <span class="nx">features</span> <span class="o">=</span> <span class="nx">view</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">features</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">features</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">blayer</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">([</span><span class="nx">features</span><span class="p">]);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">blayer</span><span class="p">.</span><span class="nx">removeFeatures</span><span class="p">([</span><span class="nx">features</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">resizeMap</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">resizeMap</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">extent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">blayer</span><span class="p">.</span><span class="nx">getDataExtent</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">extent</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">zoomToExtent</span><span class="p">(</span><span class="nx">extent</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">zoomToMaxExtent</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">FieldsSelection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click .arkiweb-fields-selection-menu .arkiweb-fields-selection-toggle-query&#39;</span><span class="o">:</span> <span class="s1">&#39;toggleQuery&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click .arkiweb-fields-selection-menu .arkiweb-fields-selection-show-query&#39;</span><span class="o">:</span> <span class="s1">&#39;showQuery&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click .arkiweb-fields-selection-menu .arkiweb-fields-selection-clear-selection&#39;</span><span class="o">:</span> <span class="s1">&#39;clearSelection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click .arkiweb-fields-selection-menu .arkiweb-fields-selection-submit-selection&#39;</span><span class="o">:</span> <span class="s1">&#39;submitSelection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click .arkiweb-fields-selection-menu .arkiweb-fields-selection-download-selection&#39;</span><span class="o">:</span> <span class="s1">&#39;downloadSelection&#39;</span>
  <span class="p">},</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;reset&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">renderError</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">content</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.arkiweb-fields-selection-content&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">toggleQuery</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-fields-selection-menu .arkiweb-fields-selection-toggle-query&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">showQuery</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-fields-selection-menu .arkiweb-fields-selection-show-query&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-fields-selection-menu .arkiweb-fields-selection-clear-selection&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-fields-selection-menu .arkiweb-fields-selection-submit-selection&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-fields-selection-menu .arkiweb-fields-selection-download-selection&quot;</span><span class="p">);</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">button</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">});</span>

  <span class="p">},</span>
  <span class="nx">buttons</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">views</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buttons</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">button</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">stats</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">FieldsSelectionStatsSection</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
        <span class="nx">el</span><span class="o">:</span> <span class="nx">div</span>
      <span class="p">});</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">FieldsSelectionSection</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
        <span class="nx">el</span><span class="o">:</span> <span class="nx">div</span>
      <span class="p">});</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">renderError</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nb">Error</span><span class="p">({</span> 
      <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">),</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Error while loading fields: &quot;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">statusText</span>
    <span class="p">});</span>
  <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">toggleQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">toggleQuery</span><span class="p">();</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">showQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">());</span>
  <span class="p">},</span>
  <span class="nx">clearSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">clearSelection</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">queries</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">queries</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">submitSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">downloadSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;download&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">FieldsSelectionStatsSection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-fields-selection-stats-section-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">stats</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">).</span><span class="nx">datetimepicker</span><span class="p">({</span>
      <span class="nx">minDate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">begin</span><span class="p">,</span>
      <span class="nx">maxDate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">end</span><span class="p">,</span>
      <span class="nx">timeFormat</span><span class="o">:</span> <span class="s1">&#39;hh:mm:ss&#39;</span><span class="p">,</span>
      <span class="nx">dateFormat</span><span class="o">:</span> <span class="s1">&#39;yy-mm-dd&#39;</span>
    <span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=from]&quot;</span><span class="p">).</span><span class="nx">datetimepicker</span><span class="p">(</span><span class="s1">&#39;setDate&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">begin</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=until]&quot;</span><span class="p">).</span><span class="nx">datetimepicker</span><span class="p">(</span><span class="s1">&#39;setDate&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">end</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">clearSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=arkiweb-reftime-from]&quot;</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;:checked&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=arkiweb-reftime-from]&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=arkiweb-reftime-until]&quot;</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;:checked&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=arkiweb-reftime-until]&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=from]&quot;</span><span class="p">).</span><span class="nx">datetimepicker</span><span class="p">(</span><span class="s1">&#39;setDate&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">begin</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=until]&quot;</span><span class="p">).</span><span class="nx">datetimepicker</span><span class="p">(</span><span class="s1">&#39;setDate&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">end</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">until</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=arkiweb-reftime-from]&quot;</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;:checked&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">begin</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=from]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=arkiweb-reftime-until]&quot;</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s1">&#39;:checked&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=until]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">begin</span><span class="p">)</span>
      <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&gt;= &quot;</span> <span class="o">+</span> <span class="nx">begin</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">end</span><span class="p">)</span>
      <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&lt;= &quot;</span> <span class="o">+</span> <span class="nx">end</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">begin</span> <span class="o">&amp;&amp;</span> <span class="nx">end</span> <span class="o">&amp;&amp;</span> <span class="nx">begin</span> <span class="o">==</span> <span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;= &quot;</span> <span class="o">+</span> <span class="nx">begin</span> <span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="nx">query</span> <span class="o">=</span> <span class="s2">&quot;reftime: &quot;</span> <span class="o">+</span> <span class="nx">values</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">toggleQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">FieldsSelectionSection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-fields-selection-section-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click h3&#39;</span><span class="o">:</span> <span class="s1">&#39;toggleSection&#39;</span>
  <span class="p">},</span>
  <span class="nx">views</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-fields-selection-section-list&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-fields-selection-section-list&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">FieldsSelectionSectionItem</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
        <span class="nx">el</span><span class="o">:</span> <span class="nx">div</span>
      <span class="p">});</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">toggleQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">toggleQuery</span><span class="p">();</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">toggleSection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-fields-selection-section-list&quot;</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">getSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">selected</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">selected</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">queries</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">selected</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">query</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">query</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">query</span> <span class="o">=</span> <span class="nx">ArkiwebParser</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)].</span><span class="nx">decode</span><span class="p">(</span><span class="nx">queries</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">query</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">clearSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">setSelection</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">FieldsSelectionSectionItem</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-fields-selection-section-item-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">description</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">).</span><span class="nx">desc</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">({</span>
      <span class="nx">description</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">).</span><span class="nx">desc</span><span class="p">,</span>
      <span class="nx">query</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">query</span>
    <span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">tmpl</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">tmpl</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.arkiweb-field-query&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">isSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;:checked&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">toggleQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-field-description, .arkiweb-field-query&quot;</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">setSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">checkbox</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">())</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">()))</span> <span class="p">{</span>
      <span class="nx">checkbox</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Summary</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-summary-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click button&#39;</span><span class="o">:</span> <span class="s1">&#39;toggleQuery&#39;</span>
  <span class="p">},</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;reset&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">empty</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">stats</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-summary-stats&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">SummaryStats</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span>
        <span class="nx">el</span><span class="o">:</span> <span class="nx">div</span>
      <span class="p">});</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
      <span class="nx">tmpl</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-summary-content&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">SummarySection</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
        <span class="nx">el</span><span class="o">:</span> <span class="nx">div</span>
      <span class="p">});</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">dialog</span><span class="p">({</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;summary&#39;</span><span class="p">,</span>
      <span class="nx">autoOpen</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">modal</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">close</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
      <span class="p">},</span>
      <span class="nx">height</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">width</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">layout</span><span class="p">({</span>
      <span class="nx">center__applyDefaultStyles</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">center__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-summary&#39;</span>
    <span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-summary&quot;</span><span class="p">).</span><span class="nx">layout</span><span class="p">({</span>
      <span class="nx">center__applyDefaultStyles</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">north__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-summary-menu&#39;</span><span class="p">,</span>
      <span class="nx">center__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-summary-content&#39;</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">toggleQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-summary-query, .arkiweb-summary-description&quot;</span><span class="p">).</span><span class="nx">toggleClass</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">SummaryStats</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-summary-stats-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">stats</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">SummarySection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-summary-section-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.arkiweb-summary-section-list&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">SummarySectionItem</span><span class="p">({</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">model</span><span class="p">,</span>
        <span class="nx">el</span><span class="o">:</span> <span class="nx">div</span>
      <span class="p">});</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">);</span>
    <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">SummarySectionItem</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-summary-section-item-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">({</span>
      <span class="nx">description</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">).</span><span class="nx">desc</span><span class="p">,</span>
      <span class="nx">query</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">query</span>
    <span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
    <span class="nx">tmpl</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-summary-query&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nb">Error</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">message</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div class=&#39;error&#39;&gt;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Postprocessor</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-postprocessor-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click input[name=arkiweb-postprocess-checkbox]&#39;</span><span class="o">:</span> <span class="s1">&#39;triggerSelection&#39;</span><span class="p">,</span>
    <span class="s1">&#39;click .arkiweb-postprocessor-name&#39;</span><span class="o">:</span> <span class="s1">&#39;showHelp&#39;</span>
  <span class="p">},</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">options</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">({</span>
      <span class="nx">map</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
      <span class="nx">datasets</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">datasets</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">({</span>
      <span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-postprocessor-item-content&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot; input[name=arkiweb-postprocess-checkbox]&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">disable</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">color</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">disable</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;checked&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">enable</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">triggerSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">isSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span><span class="p">).</span><span class="nx">is</span><span class="p">(</span><span class="s2">&quot;:checked&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">setSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">())</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">()))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">checkbox</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">showHelp</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">help</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">AbstractPostprocessor</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">name</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
  <span class="nx">help</span><span class="o">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
  <span class="nx">activate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">},</span>
  <span class="nx">deactivate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">},</span>
  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">.</span><span class="nx">Singlepoint</span> <span class="o">=</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">AbstractPostprocessor</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="s2">&quot;singlepoint&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">style</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">strokeColor</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span>
        <span class="nx">strokeOpacity</span><span class="o">:</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
        <span class="nx">strokeWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">fillColor</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span>
        <span class="nx">fillOpacity</span><span class="o">:</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
        <span class="nx">pointRadius</span><span class="o">:</span> <span class="mi">3</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">control</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">();</span>
    <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Util</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">draw</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">control</span><span class="p">,</span> <span class="p">{</span>
          <span class="s2">&quot;done&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">notice</span>
        <span class="p">});</span>
      <span class="p">},</span>
      <span class="nx">activate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">deactivate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">notice</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">updateInput</span><span class="p">({</span>
          <span class="nx">x</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
          <span class="nx">y</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">activate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">setVisibility</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">deactivate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">setVisibility</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;singlepoint&quot;</span><span class="p">,</span>
  <span class="nx">help</span><span class="o">:</span> <span class="s2">&quot;This postprocessor extract a single point of the selection.\nYou can select the point clicking on the map and/or filling the input fields\n&quot;</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;lat &lt;input type=&#39;text&#39; name=&#39;lat&#39;&gt; lon &lt;input type=&#39;text&#39; name=&#39;lon&#39;/&gt;&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[type=text]&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">onChangeInputCoords</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">updateInput</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">y</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">updateMap</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">feature</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">y</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">removeAllFeatures</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">([</span><span class="nx">feature</span><span class="p">]);</span>
  <span class="p">},</span>
  <span class="nx">onChangeInputCoords</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">({</span> 
      <span class="nx">x</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
      <span class="nx">y</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;singlepoint &quot;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">.</span><span class="nx">Subarea</span> <span class="o">=</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">AbstractPostprocessor</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="s2">&quot;subarea&quot;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">style</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">strokeColor</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span>
        <span class="nx">strokeOpacity</span><span class="o">:</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
        <span class="nx">strokeWidth</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">fillColor</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span>
        <span class="nx">fillOpacity</span><span class="o">:</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
        <span class="nx">pointRadius</span><span class="o">:</span> <span class="mi">3</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">control</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">();</span>
    <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Util</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">draw</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Box</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">control</span><span class="p">,</span> <span class="p">{</span>
          <span class="s2">&quot;done&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">notice</span>
        <span class="p">});</span>
      <span class="p">},</span>
      <span class="nx">activate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">deactivate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">notice</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bounds</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">ll</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getLonLatFromPixel</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Pixel</span><span class="p">(</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">bottom</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">ur</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getLonLatFromPixel</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Pixel</span><span class="p">(</span><span class="nx">bounds</span><span class="p">.</span><span class="nx">right</span><span class="p">,</span> <span class="nx">bounds</span><span class="p">.</span><span class="nx">top</span><span class="p">));</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">updateInput</span><span class="p">({</span>
          <span class="nx">x</span><span class="o">:</span> <span class="nx">ll</span><span class="p">.</span><span class="nx">lon</span><span class="p">,</span>
          <span class="nx">X</span><span class="o">:</span> <span class="nx">ur</span><span class="p">.</span><span class="nx">lon</span><span class="p">,</span>
          <span class="nx">y</span><span class="o">:</span> <span class="nx">ll</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span>
          <span class="nx">Y</span><span class="o">:</span> <span class="nx">ur</span><span class="p">.</span><span class="nx">lat</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
  <span class="nx">activate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">setVisibility</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">deactivate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">setVisibility</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;subarea&quot;</span><span class="p">,</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;lat1 &lt;input type=&#39;text&#39; name=&#39;lat1&#39;&gt; lon1 &lt;input type=&#39;text&#39; name=&#39;lon1&#39;/&gt; lat2 &lt;input type=&#39;text&#39; name=&#39;lat2&#39;/&gt; lon2 &lt;input type=&#39;text&#39; name=&#39;lon2&#39;/&gt;&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[type=text]&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">updateMap</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">updateInput</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon1]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon2]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">X</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat1]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat2]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">Y</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">updateMap</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon1]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat1]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">X</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon2]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">Y</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat2]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">points</span> <span class="o">=</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">),</span>
      <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">X</span><span class="p">,</span> <span class="nx">y</span><span class="p">),</span>
      <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">X</span><span class="p">,</span> <span class="nx">Y</span><span class="p">),</span>
      <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">Y</span><span class="p">),</span>
      <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">];</span>
    <span class="kd">var</span> <span class="nx">feature</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.</span><span class="nx">LinearRing</span><span class="p">(</span><span class="nx">points</span><span class="p">));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">removeAllFeatures</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">([</span><span class="nx">feature</span><span class="p">]);</span>
  <span class="p">},</span>
  <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lons</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon1]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lon2]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">];</span>
    <span class="kd">var</span> <span class="nx">lats</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat1]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input[name=lat2]&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="p">];</span>
    <span class="k">return</span> <span class="s2">&quot;subarea &quot;</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">lons</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">lats</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">lons</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">_</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">lats</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Postprocessors</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">map</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">datasets</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">postprocessors</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postprocessor</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-postprocess-content&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Postprocessor</span><span class="p">({</span>
          <span class="nx">postprocessor</span><span class="o">:</span> <span class="nx">postprocessor</span><span class="p">,</span>
          <span class="nx">map</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
          <span class="nx">datasets</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">datasets</span><span class="p">,</span>
          <span class="nx">el</span><span class="o">:</span> <span class="nx">div</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onChangedSelection</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onDatasetsSelectionChanged</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postprocessor</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">postprocessor</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">onDatasetsSelectionChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">selected</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">postprocessors</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">selected</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">postprocessors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;postprocess&#39;</span><span class="p">));</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      <span class="nx">postprocessors</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">intersection</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">postprocessors</span><span class="p">);</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span><span class="nx">postprocessors</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">p</span><span class="p">.</span><span class="nx">enable</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">p</span><span class="p">.</span><span class="nx">disable</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">onChangedSelection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">p</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onChangedSelection</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">!=</span> <span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">setSelection</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">p</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onChangedSelection</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">getValue</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">postprocessor</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">postprocessor</span><span class="p">.</span><span class="nx">isSelected</span><span class="p">())</span> <span class="p">{</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">postprocessor</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>

<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Main</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s2">&quot;#arkiweb-tmpl&quot;</span><span class="p">,</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">Datasets</span><span class="p">()</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">urls</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">Fields</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">urls</span><span class="p">.</span><span class="nx">fields</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">summary</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">Fields</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">summary</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">urls</span><span class="p">.</span><span class="nx">summary</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">summary</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">urls</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">urls</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="s1">&#39;data&#39;</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">postprocessors</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">postprocessors</span> <span class="o">||</span> <span class="p">[</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">.</span><span class="nx">Subarea</span><span class="p">,</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">.</span><span class="nx">Singlepoint</span> <span class="p">];</span>

  <span class="p">},</span>
  <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmpl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">tmpl</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;arkiweb&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">DatasetsSelection</span><span class="p">({</span>
      <span class="nx">collection</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">datasets</span><span class="p">,</span>
      <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.arkiweb-datasets-selection&#39;</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadFields</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
      <span class="nx">view</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">datasets</span><span class="p">,</span>
      <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.arkiweb-map&#39;</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">FieldsSelection</span><span class="p">({</span>
      <span class="nx">collection</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">fields</span><span class="p">,</span>
      <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.arkiweb-fields-selection&#39;</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadSummary</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">downloadData</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">summary</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Summary</span><span class="p">({</span>
      <span class="nx">collection</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">summary</span><span class="p">,</span>
      <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">)</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Postprocessors</span><span class="p">({</span>
      <span class="nx">map</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">map</span><span class="p">,</span>
      <span class="nx">datasets</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">datasets</span><span class="p">,</span>
      <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;.arkiweb-postprocess&quot;</span><span class="p">),</span>
      <span class="nx">postprocessors</span><span class="o">:</span> <span class="p">[</span>
        <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">.</span><span class="nx">Singlepoint</span><span class="p">,</span>
        <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">.</span><span class="nx">Subarea</span>
      <span class="p">]</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">layouts</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layouts</span><span class="p">.</span><span class="nx">main</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">layout</span><span class="p">({</span>
      <span class="nx">applyDefaultStyles</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">west__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-datasets-selection&#39;</span><span class="p">,</span>
      <span class="nx">east__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-fields-selection&#39;</span><span class="p">,</span>
      <span class="nx">center__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-map&#39;</span><span class="p">,</span>
      <span class="nx">south__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-postprocess&#39;</span><span class="p">,</span>
      <span class="nx">south__size</span><span class="o">:</span> <span class="s1">&#39;40%&#39;</span><span class="p">,</span>
      <span class="nx">west__size</span><span class="o">:</span> <span class="s1">&#39;33%&#39;</span><span class="p">,</span>
      <span class="nx">east__size</span><span class="o">:</span> <span class="s1">&#39;33%&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layouts</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">layout</span><span class="p">({</span>
      <span class="nx">center__applyDefaultStyles</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">north__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-datasets-selection-header&#39;</span><span class="p">,</span>
      <span class="nx">center__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-datasets-selection-content&#39;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">layouts</span><span class="p">.</span><span class="nx">fields</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">layout</span><span class="p">({</span>
      <span class="nx">center__applyDefaultStyles</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">north__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-fields-selection-header&#39;</span><span class="p">,</span>
      <span class="nx">center__paneSelector</span><span class="o">:</span> <span class="s1">&#39;.arkiweb-fields-selection-content&#39;</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">loadDatasets</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">getDatasetsParam</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">datasets</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">(),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">datasets</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">getPostprocessParam</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">postprocess</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">postprocessors</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">postprocess</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">getQueryParam</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">loadDatasets</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">datasets</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
      <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">loadFields</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="kd">var</span> <span class="nx">datasets</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDatasetsParam</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">datasets</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">=</span> <span class="nx">datasets</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
      <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">loadSummary</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">datasets</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDatasetsParam</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">datasets</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">=</span> <span class="nx">datasets</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getQueryParam</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">query</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">summary</span><span class="p">.</span><span class="nx">fetch</span><span class="p">({</span>
      <span class="nx">beforeSend</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">block</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">unblock</span><span class="p">();</span>
      <span class="p">},</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">downloadData</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">datasets</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDatasetsParam</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">datasets</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span> <span class="o">=</span> <span class="nx">datasets</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getQueryParam</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">query</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">postprocess</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPostprocessParam</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">postprocess</span><span class="p">)</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">postprocess</span> <span class="o">=</span> <span class="nx">postprocess</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">urls</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">block</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;&lt;img src=&#39;ajax-loader.gif&#39; alt=&#39;loading&#39;/&gt;&lt;/div&gt;&quot;</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">blockUI</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">css</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">block</span><span class="p">({</span>
      <span class="nx">message</span><span class="o">:</span> <span class="nx">img</span>
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="nx">unblock</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nx">unblock</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>


<span class="nx">arkiweb</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">Router</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;#arkiweb-tmpl&#39;</span><span class="p">,</span>
  <span class="nx">settings</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">el</span><span class="o">:</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span>
    <span class="nx">urls</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">tmpl</span><span class="o">:</span> <span class="s1">&#39;arkiweb.html&#39;</span><span class="p">,</span>
      <span class="nx">datasets</span><span class="o">:</span> <span class="s1">&#39;datasets&#39;</span><span class="p">,</span>
      <span class="nx">fields</span><span class="o">:</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span>
      <span class="nx">summary</span><span class="o">:</span> <span class="s1">&#39;summary&#39;</span><span class="p">,</span>
      <span class="nx">download</span><span class="o">:</span> <span class="s1">&#39;download&#39;</span>
    <span class="p">},</span>
    <span class="nx">height</span><span class="o">:</span> <span class="s1">&#39;100%&#39;</span>
  <span class="p">},</span>
  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loadTemplates</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mainview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">arkiweb</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Main</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">);</span>
  <span class="p">},</span>  
  <span class="nx">loadTemplates</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">urls</span><span class="p">.</span><span class="nx">tmpl</span><span class="p">,</span>
        <span class="nx">async</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">routes</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;&quot;</span><span class="o">:</span> <span class="s2">&quot;index&quot;</span>
  <span class="p">},</span>
  <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mainview</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>



<span class="nb">window</span><span class="p">.</span><span class="nx">arkiweb</span> <span class="o">=</span> <span class="nx">arkiweb</span>

<span class="p">}());</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 